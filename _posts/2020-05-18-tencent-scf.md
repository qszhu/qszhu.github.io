---
layout: post
title: è…¾è®¯äº‘äº‘å‡½æ•°å®è·µ
date: 2020-05-23 22:51:00 +0800
tags: [tencent_cloud, serverless, faas, tencent_scf, wechat_mina]
---

### 1. èƒŒæ™¯

å¾®ä¿¡å°ç¨‹åºç°å¯æ¥å…¥ç‰©æµ[1]ï¼Œå®ç°ä¸‹å•ã€æ‰“å•å’Œç‰©æµè·Ÿè¸ªç­‰åŠŸèƒ½ã€‚å¯¹äºæ‰“å•åŠŸèƒ½ï¼Œå¾®ä¿¡æä¾›äº†å‡ ç§ä¸åŒçš„æ¥å…¥æ–¹å¼ï¼Œå¦‚windows onlyçš„æ‰“å•è½¯ä»¶æˆ–éœ€è¦é¢å¤–æ¥å…¥çš„ç¬¬ä¸‰æ–¹æ‰“å•è½¯ä»¶ï¼Œå¦åˆ™éœ€è¦é€šè¿‡`getOrder`æ¥å£è·å–æ•°æ®è‡ªè¡Œæ‰“å°[2]ã€‚`getOrder`æ¥å£ä¼šè¿”å›base64ç¼–ç çš„è¿å•htmlé¡µé¢ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ¸²æŸ“å‡ºæ¥æ‰“å°ä¼šé‡åˆ°çš„æœ€ä¸»è¦çš„é—®é¢˜æ˜¯æµè§ˆå™¨çš„å…¼å®¹æ€§ï¼Œå¯é€šè¿‡ä½¿ç”¨å¯æ§çš„æµè§ˆå™¨æ¸²æŸ“å‡ºé¡µé¢å†ä¿å­˜ä¸ºå›¾ç‰‡çš„æ–¹å¼è§£å†³ã€‚åœ¨è¿™æ–¹é¢`puppeteer`[3]å¯ä»¥è¯´æ˜¯é¦–é€‰ã€‚

![å¿«é€’å•](/assets/images/2020-05-23/WX20200524-164924@2x.png)

*éœ€æ¸²æŸ“çš„å¿«é€’å•*

ä¸è¿‡`puppeteer`ä¹Ÿæœ‰è‡ªå·±çš„é—®é¢˜ã€‚æ¯”å¦‚ç°åœ¨çš„åç«¯å¤§å¤šæ˜¯ä»¥å®¹å™¨æ–¹å¼éƒ¨ç½²çš„ï¼Œè€Œé…ç½®`puppeteer`åœ¨å®¹å™¨ä¸­è¿è¡Œå¹¶ä¸æ–¹ä¾¿[4]ï¼Œä¸”é…ç½®ä¸å½“å¯èƒ½æœ‰æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚æ°é€¢æœ€è¿‘åœ¨è°ƒç ”`FaaS`ï¼Œå°±æƒ³ç€æ—¢ç„¶`serverless`æ–¹å¼éƒ¨ç½²å¯ä»¥ä¸å…³å¿ƒæœåŠ¡å™¨ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½è½¬å«æ‰é£é™©äº†ï¼Ÿ

### 2. é—®é¢˜è°ƒç ”

`puppeteer`è¿è¡Œéœ€è¦`Node.js`ã€‚æ ¹æ®è…¾è®¯äº‘çš„æ–‡æ¡£[5]ï¼Œ`Node.js`åº”ç”¨éœ€è¦å°†ä¾èµ–åº“ä¸€åŒæ‰“åŒ…ä¸Šä¼ ã€‚ç”±äº`puppeteer`ä¾èµ–äº†`Chromium`ï¼Œå°±æ„å‘³ç€éœ€è¦åœ¨`CentOS`ä¸‹å®‰è£…ä¸€ä¸ª`Chromium`å¹¶æ‰“åŒ…ä¸Šä¼ ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å› ä¸ºç¯å¢ƒä¸ä¸€è‡´è€Œå‡ºé—®é¢˜ã€‚å¥½åœ¨è…¾è®¯äº‘çš„`Node.js`ç¯å¢ƒ[6]å·²ç»å†…ç½®äº†`puppeteer`ï¼Œéƒ¨ç½²æ—¶å°±ä¸ç”¨å†ä¸Šä¼ äº†ã€‚

ä¸è¿‡åœ¨æœ¬åœ°è¿˜æ˜¯éœ€è¦å®‰è£…`puppeteer`ï¼Œå¦åˆ™å°±æ— æ³•åœ¨æœ¬åœ°è°ƒè¯•äº†ã€‚é‚£ä¹ˆåœ¨éƒ¨ç½²æ—¶å¦‚ä½•æ‰èƒ½ä¸ä¸Šä¼ æœ¬åœ°å®‰è£…çš„`puppeteer`å‘¢ï¼Ÿæ ¹æ®`serverless`çš„çº¦å®šï¼Œåªè¦æŠŠ`puppeteer`ä½œä¸º`devDependencies`å®‰è£…ï¼Œä½¿ç”¨`serverless`å‘½ä»¤è¡Œéƒ¨ç½²æ—¶å°±ä¼šè¢«è‡ªåŠ¨å¿½ç•¥ï¼Œä¸ä¼šè¢«æ‰“åŒ…è¿›å»äº†ã€‚

### 3. å¼€å‘

å¼€å‘æ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼ŒåŸºæœ¬ä¸Šåªè¦æŠŠ`puppeteer`å’Œè…¾è®¯äº‘äº‘å‡½æ•°å„è‡ªæœ€ç®€å•çš„sampleè¿èµ·æ¥å°±å¯ä»¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è…¾è®¯äº‘äº‘å‡½æ•°å¯¹å‡½æ•°å…¥å£çš„å½¢å¼æœ‰è§„å®š[7]ï¼Œå¯ä»¥è¯´æ˜¯ç§æä¾›å•†ç»‘å®šï¼Œå¦‚æœè¦è§£é™¤ç»‘å®šçš„è¯å°±éœ€è¦è‡³å°‘å¤šåŠ ä¸€å±‚æŠ½è±¡ã€‚

### 4. éƒ¨ç½²

ä½¿ç”¨`serverlesss`å‘½ä»¤è¡Œç”Ÿæˆçš„é»˜è®¤`serverless.yml`ä¸­æ²¡æœ‰æŒ‡å®šç½‘å…³ï¼Œapiç½‘å…³è§¦å‘å™¨çš„`serviceId`ä¸ºç©º

```yaml
    events:
      - apigw:
          parameters:
            stageName: test 
            serviceId:
            httpMethod: ANY
```

è¿™å°±ä¼šå¯¼è‡´æ¯æ¬¡éƒ¨ç½²æ—¶å‡åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘å…³ï¼Œè®¿é—®é“¾æ¥ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ã€‚å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡éƒ¨ç½²åæŠŠåˆ›å»ºçš„ç½‘å…³çš„`serviceId`å¡«å›`serverless.yml`ä¸­ï¼ˆæˆ–æ˜¯éƒ¨ç½²ä¹‹å‰å…ˆè‡ªå·±æ‰‹åŠ¨åœ¨è…¾è®¯äº‘çš„æ§åˆ¶å°åˆ›å»ºä¸€ä¸ªAPIç½‘å…³ï¼‰ï¼Œè¿™æ ·å°±èƒ½å¤ç”¨è¿™ä¸ªç½‘å…³ï¼Œè®¿é—®åœ°å€ä¹Ÿä¸ä¼šå˜ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ä½œåå‘ä»£ç†çš„ä¸Šæ¸¸ã€‚

åœ¨çº¿è°ƒè¯•æ—¶ä¾æ—§é‡åˆ°äº†å¸¸è§çš„`No usable sandbox!`é”™è¯¯[8]ã€‚é‰´äºæ˜¯`serverless`ç¯å¢ƒæ— æ³•é…ç½®æœåŠ¡å™¨ï¼Œåªèƒ½ä»¥æ— æ²™ç›’æ–¹å¼å¯åŠ¨ã€‚ç›¸ä¿¡è…¾è®¯äº‘åº”è¯¥æœ‰è¶³å¤Ÿçš„å®‰å…¨æªæ–½ğŸ¶

### 5. å…¶ä»–é—®é¢˜

#### 5.1 TypeScript

å½“å‰`JavaScript`åç«¯å¼€å‘åŸºæœ¬éƒ½ä¼šé‡‡ç”¨`TypeScript`ï¼Œè€Œè…¾è®¯äº‘çš„sampleè¿˜éƒ½æ˜¯`JavaScript`çš„ã€‚å…¶å®ç”¨`TypeScript`å¼€å‘äº‘å‡½æ•°å¾ˆç®€å•ï¼Œåªéœ€ç¡®ä¿`tsc`ç¼–è¯‘çš„è¾“å‡ºç›®å½•ä¸­åŒ…å«äº‘å‡½æ•°æ‰€éœ€çš„æ–‡ä»¶å³å¯ã€‚é€šè¿‡ä¸€ä¸ªç®€å•çš„è„šæœ¬å°±å¯ä»¥æå®šï¼š

```bash
# ç¼–è¯‘.tsæ–‡ä»¶ï¼Œè¾“å‡ºåˆ° dist/ ç›®å½•
$ npm run build

# å¤åˆ¶ package.json å’Œ package-lock.json
$ cp package* dist/

# å¤åˆ¶ serverless.yml
$ cp serverless.yml dist/

$ cd dist

# åªå®‰è£… production ä¾èµ–
$ npm ci --only=production

# serverless éƒ¨ç½²
$ sls deploy
```

#### 5.2 ä½¿ç”¨Webæ¡†æ¶

ä¸Šé¢æåˆ°ï¼Œç”±äºè…¾è®¯äº‘å¯¹äºäº‘å‡½æ•°çš„å‡½æ•°å…¥å£æœ‰è¦æ±‚ï¼Œå¯¹äºå·²æœ‰çš„é¡¹ç›®å¯èƒ½å°±éœ€è¦è¿ç§»ï¼Œè€Œè¿ç§»çš„ç»“æœå¯èƒ½å°±æ˜¯æä¾›å•†ç»‘å®šã€‚ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œç°æœ‰çš„åŠŸèƒ½åº”è¯¥èƒ½åœ¨ä¸åŒçš„äº‘æä¾›å•†ä¹‹é—´æ— ç¼è¿ç§»ã€‚ç›®å‰å·²ç»æœ‰äº›é¡¹ç›®æä¾›äº†å¸¸è§çš„Webæ¡†æ¶å¦‚`Express`å’Œ`koa`çš„æ”¯æŒï¼Œæœ‰æ—¶é—´çš„è¯ä¼šç»§ç»­å®è·µã€‚

update: åç»­åœ¨[è¿™é‡Œ](/2020-05-31-tencent-serverless-components.md)

### 6. å°ç»“

å®é™…ç”¨ä¸‹æ¥çš„æ„Ÿè§‰ï¼Œ`FaaS`æ¯”è¾ƒé€‚åˆçš„åœºæ™¯æ˜¯ï¼š

* å¯¹å“åº”å»¶è¿Ÿè¦æ±‚ä½
* å¹¶å‘é‡ä¸å¤§
* è°ƒç”¨æ¬¡æ•°ä¸å¤š
* æ— çŠ¶æ€

åƒä¸Šé¢æåˆ°çš„ç½‘é¡µè½¬å›¾ç‰‡çš„æœåŠ¡å°±æ˜¯è¿™æ ·çš„ä¾‹å­ã€‚ä¸€ä¸ªä¼ä¸šå†…éƒ¨å¯èƒ½æœ‰å¤§é‡åƒè¿™æ ·çš„é•¿å°¾æœåŠ¡ï¼Œä½¿ç”¨é‡å°ï¼Œä½¿ç”¨å‘¨æœŸçŸ­ï¼Œå´ä¾æ—§éœ€è¦å’Œå¤´éƒ¨çš„æœåŠ¡ä¸€è§†åŒä»åœ°è¿›è¡Œéƒ¨ç½²å’Œç»´æŠ¤ã€‚å¦‚æœé‡‡ç”¨`FaaS`çš„è¯å¼€å‘è€…è‡ªå·±å°±èƒ½å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œéƒ¨ç½²ï¼Œä»è€ŒèŠ‚çœå¤§é‡è¿ç»´èµ„æºã€‚æ­¤å¤–äº‘æœåŠ¡å•†é€šå¸¸éƒ½æä¾›äº†å……æ²›çš„å…è´¹é¢åº¦ï¼Œè¿™æ ·éƒ¨ç½²å’Œä½¿ç”¨äº‘å‡½æ•°åŸºæœ¬å°±æ˜¯åœ¨ç™½å«–äº†ã€‚

p.s. `puppeteer`ç»å¸¸è¢«ç”¨æ¥åšçˆ¬è™«ï¼Œè€Œåœ¨è…¾è®¯äº‘çš„æ–‡æ¡£ä¸­å†™ç€ï¼Œäº‘å‡½æ•°çš„å‡ºå£IPåœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯éšæœºçš„[9]ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆè¿˜éœ€è¦è§‚å¯ŸğŸ¶

### å‚è€ƒèµ„æ–™
* [1] [å¿«é€’æ¥å£ï¼ˆå•†å®¶å¿…çœ‹ï¼‰ \| å¾®ä¿¡å¼€æ”¾æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/express/introduction.html)
* [2] [logistics.getOrder \| å¾®ä¿¡å¼€æ”¾æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/express/by-business/logistics.getOrder.html)
* [3] [GitHub - puppeteer/puppeteer: Headless Chrome Node.js API](https://github.com/puppeteer/puppeteer)
* [4] [puppeteer/troubleshooting.md at master Â· puppeteer/puppeteer Â· GitHub](https://github.com/puppeteer/puppeteer/blob/master/docs/troubleshooting.md#running-puppeteer-in-docker)
* [5] [äº‘å‡½æ•° ä¾èµ–å®‰è£… - å¼€å‘æŒ‡å— - æ–‡æ¡£ä¸­å¿ƒ - è…¾è®¯äº‘](https://cloud.tencent.com/document/product/583/39780#node.js-.E8.BF.90.E8.A1.8C.E6.97.B6)
* [6] [äº‘å‡½æ•° Node.js è¯´æ˜ - å¼€å‘æŒ‡å— - æ–‡æ¡£ä¸­å¿ƒ - è…¾è®¯äº‘](https://cloud.tencent.com/document/product/583/11060#.E7.8E.AF.E5.A2.83.E5.86.85.E7.9A.84.E5.86.85.E7.BD.AE.E5.BA.93)
* [7] [äº‘å‡½æ•° åŸºæœ¬æ¦‚å¿µ - å¼€å‘æŒ‡å— - æ–‡æ¡£ä¸­å¿ƒ - è…¾è®¯äº‘](https://cloud.tencent.com/document/product/583/9210#.E6.89.A7.E8.A1.8C.E6.96.B9.E6.B3.95)
* [8] [puppeteer/troubleshooting.md at master Â· puppeteer/puppeteer Â· GitHub](https://github.com/puppeteer/puppeteer/blob/master/docs/troubleshooting.md#setting-up-chrome-linux-sandbox)
* [9] [äº‘å‡½æ•° é€šç”¨ç±» - å¸¸è§é—®é¢˜ - æ–‡æ¡£ä¸­å¿ƒ - è…¾è®¯äº‘](https://cloud.tencent.com/document/product/583/9180#scf-.E8.AE.BF.E9.97.AE.E5.A4.96.E7.BD.91.E6.97.B6-ip-.E6.98.AF.E9.9A.8F.E6.9C.BA.E7.9A.84.E8.BF.98.E6.98.AF.E5.9B.BA.E5.AE.9A.E7.9A.84.EF.BC.9F)
